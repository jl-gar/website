{{/* gallery shortcode: reads images.json from the page bundle and exposes a JS array of image objects with resolved
URLs. */}}
{{ $jres := .Page.Resources.GetMatch "images.json" }}
{{ if not $jres }}
<p class="jl-gallery-missing">No images.json found for this page.</p>
{{ else }}
{{ $raw := $jres.Content }}
{{/* remove UTF-8 BOM bytes if present (EF BB BF) then trim leading whitespace */}}
{{ $raw = replaceRE "^\\xef\\xbb\\xbf" "" $raw }}
{{ $raw = replaceRE "^\\s+" "" $raw }}
{{ $images := transform.Unmarshal $raw }}
{{/* Get fullres parameter (default: false) - if true, use original images in lightbox */}}
{{ $fullres := eq ($.Get "fullres") "true" }}
{{ $imgsSlice := slice }}
{{ range $i, $img := $images }}
    {{ $fname := path.Base $img.file }}
    {{ $res := $.Page.Resources.GetMatch (printf "media/%s" $fname) }}
    {{ $url := "" }}
    {{ $thumbURL := "" }}
    {{ $displayURL := "" }}
    {{ $displayW := 0 }}
    {{ $displayH := 0 }}
    {{ if $res }}
        {{ $url = $res.RelPermalink }}
    {{/* Thumbnail sizing: values must match CSS variables in gallery.css:
         --gallery-thumb-height: 150px
         --gallery-thumb-max-width: 300px
         --gallery-display-max-width: 1600px */}}
    {{ $thumbHeight := 150 }}
    {{ $thumbMaxWidth := 300 }}
    {{ $displayMaxWidth := 1600 }}
    
    {{/* create a thumbnail with fixed height, but limit width to max */}}
    {{ $thumb := $res.Resize (printf "x%d" $thumbHeight) }}
        {{ if $thumb }}
            {{/* check if width exceeds max and resize to max width if needed */}}
            {{ if gt $thumb.Width $thumbMaxWidth }}
                {{ $thumb = $res.Resize (printf "%dx" $thumbMaxWidth) }}
            {{ end }}
            {{ $thumbURL = $thumb.RelPermalink }}
        {{ else }}
            {{ $thumbURL = $res.RelPermalink }}
        {{ end }}
        {{/* create a display image for PhotoSwipe - use original if fullres=true */}}
        {{ if $fullres }}
            {{ $displayURL = $res.RelPermalink }}
            {{ $displayW = $res.Width }}
            {{ $displayH = $res.Height }}
        {{ else }}
            {{/* create a medium display image (resize keeping aspect) */}}
            {{ $display := $res.Resize (printf "%dx" $displayMaxWidth) }}
            {{ if $display }}
                {{ $displayURL = $display.RelPermalink }}
                {{ $displayW = $display.Width }}
                {{ $displayH = $display.Height }}
            {{ else }}
                {{ $displayURL = $res.RelPermalink }}
                {{ $displayW = $res.Width }}
                {{ $displayH = $res.Height }}
            {{ end }}
        {{ end }}
    {{ else }}
        {{/* try site static path fallback */}}
        {{ $url = (printf "/%s" (printf "docs/%s/%s" .Page.File.Dir $fname)) | relURL }}
        {{ $thumbURL = $url }}
    {{ end }}
    {{ $entry := dict "url" $url "display" $displayURL "w" $displayW "h" $displayH "thumb" $thumbURL "title" $img.title "date" $img.date "dimensions" $img.dimensions_physical "series" $img.series "notes" $img.notes "id" $img.id "original_name" $img.original_name }}
    {{ $imgsSlice = $imgsSlice | append $entry }}
{{ end }}
{{ $imgs := $imgsSlice }}

{{ $first := index $imgs 0 }}
{{/* create a safe id for the gallery by replacing slashes and other unsafe chars with dashes */}}
{{ $rawPath := .Page.File.Path }}
{{ $gidSafe := replaceRE "[^A-Za-z0-9_-]+" "-" $rawPath }}
{{/* Get background color parameter (default: grey) */}}
{{ $bg := .Get "bg" | default "grey" }}
{{/* Get showcaptions parameter (default: true) */}}
{{ $showCaptions := .Get "showcaptions" | default "true" }}
{{ $captionClass := "" }}
{{ if ne $showCaptions "true" }}
    {{ $captionClass = "jl-gallery-hide-captions" }}
{{ end }}
<div class="jl-gallery jl-gallery-tiles {{ $captionClass }}" id="pswp-gallery-{{ $gidSafe }}" data-gallery-uid="{{ .Page.File.Path | urlize }}" data-bg="{{ $bg }}">
    <!-- fallback main image element (hidden) so gallery.js can safely call show(0) -->
    <div class="jl-gallery-view" aria-hidden="true" style="display:none;">
        <img class="jl-gallery-img" src="" alt="" />
    </div>
    <div class="jl-tiles-grid">
        {{ range $i, $img := $imgs }}
            <figure class="jl-tile" data-index="{{ $i }}">
                <a href="{{ $img.url }}" data-index="{{ $i }}" class="jl-tile-link" data-pswp-src="{{ $img.display }}" data-pswp-width="{{ $img.w }}" data-pswp-height="{{ $img.h }}" data-pswp-caption-title="{{ $img.title }}" data-pswp-caption-dimensions="{{ $img.dimensions }}" data-pswp-caption-date="{{ $img.date }}" data-pswp-caption-series="{{ $img.series }}">
                    <div class="jl-tile-img-wrap">
                        <img class="jl-tile-img" src="{{ $img.thumb }}" alt="{{ $img.title }}" loading="lazy" />
                    </div>
                </a>
                <figcaption class="jl-tile-caption">
                    <a href="{{ $img.url }}" class="jl-tile-title">{{ $img.title }}</a>
                    <div class="jl-tile-dim">{{ $img.dimensions }}</div>
                </figcaption>
            </figure>
        {{ end }}
    </div>
</div>
{{/* expose images data for the gallery script in a JSON blob to avoid template quoting issues */}}
<script id  ="jl-gallery-data-{{ .Page.File.Path | urlize }}" type="application/json">
    {{ $imgs | jsonify | safeJS }}
</script>

{{/* PhotoSwipe v5: include CSS and initialize via ESM module. We add data-pswp-* attributes on anchors above so PhotoSwipe v5 can use them. */}}
<link rel="stylesheet" href="https://unpkg.com/photoswipe@5/dist/photoswipe.css">

{{ $ver := now.Unix }}
<link rel="stylesheet" href="{{ printf "%s%s?v=%d" .Site.BaseURL "css/gallery.css" $ver }}">

<script type="module" defer>
    import PhotoSwipeLightbox from 'https://unpkg.com/photoswipe@5/dist/photoswipe-lightbox.esm.js';

    // initialize a lightbox that will bind to anchors inside this shortcode's gallery container
    const GID = 'pswp-gallery-{{ $gidSafe }}';
    const GSEL = '#' + GID;
    console.debug('[JL-Gallery] PhotoSwipe init script running for', GSEL);
    console.debug('[JL-Gallery] anchors found at script run:', document.querySelectorAll(GSEL + ' a.jl-tile-link').length);
    document.querySelectorAll(GSEL + ' a.jl-tile-link').forEach(function(a){
        a.addEventListener('click', function(e){
            console.debug('[JL-Gallery] anchor clicked', a.getAttribute('data-index'), a.getAttribute('data-pswp-caption-title'), a.getAttribute('data-pswp-caption-dimensions'), a.getAttribute('data-pswp-caption-date'));
        });
    });

    const lightbox = new PhotoSwipeLightbox({
        gallery: GSEL,
        children: 'a.jl-tile-link',
        // dynamically load the PhotoSwipe core module per docs (keeps bundle small)
        pswpModule: () => import('https://unpkg.com/photoswipe@5/dist/photoswipe.esm.js'),
        
    initialZoomLevel: 'fit',
    // Allow zooming beyond 100% so small images can be zoomed in
    // secondaryZoomLevel is the zoom ratio toggled to on double-click/double-tap
    secondaryZoomLevel: 2,
    // Allow higher max zoom for better zooming on high-DPI screens
    maxZoomLevel: 8,
    // Support wheel/pinch zoom
    wheelToZoom: true,

        showHideAnimationType: 'fade',
        // Padding as percentage of viewport - reads from CSS variable --pswp-padding-percent
        paddingFn: (viewportSize) => {
            const paddingPercent = parseFloat(
                getComputedStyle(document.documentElement)
                    .getPropertyValue('--pswp-padding-percent')
            ) / 100 || 0.10; // fallback to 10% if CSS var not found
            return {
                top: Math.round(viewportSize.y * paddingPercent),
                bottom: Math.round(viewportSize.y * paddingPercent),
                left: Math.round(viewportSize.x * paddingPercent),
                right: Math.round(viewportSize.x * paddingPercent)
            };
        }
    });
    // Extra defensive options to help zoom small images across devices
    lightbox.options.allowPanToZoom = true;
    lightbox.options.pinchToClose = false;
    console.debug('[JL-Gallery] PhotoSwipeLightbox created', typeof lightbox);
    
    // Apply background color class to PhotoSwipe
    const bgColor = document.querySelector(GSEL).getAttribute('data-bg') || 'grey';
    console.debug('[JL-Gallery] Background color:', bgColor);
    
    const applyBackground = function() {
        if (lightbox.pswp && lightbox.pswp.element) {
            lightbox.pswp.element.classList.add('pswp-bg-' + bgColor);
            console.debug('[JL-Gallery] Applied background class: pswp-bg-' + bgColor);
            
            // Also apply background directly as inline style for white background
            if (bgColor === 'white') {
                const bgElements = [
                    lightbox.pswp.element,
                    lightbox.pswp.element.querySelector('.pswp__bg'),
                    lightbox.pswp.element.querySelector('.pswp__ui')
                ];
                bgElements.forEach(function(el) {
                    if (el) {
                        el.style.background = '#ffffff';
                        el.style.backgroundColor = '#ffffff';
                    }
                });
            }
        }
    };
    
    lightbox.on('beforeOpen', applyBackground);
    lightbox.on('afterInit', applyBackground);
    
    lightbox.init();
    lightbox.options.loop = false;
    console.debug('[JL-Gallery] PhotoSwipeLightbox.init called for', GSEL);
    // expose for debugging and programmatic control
    try { window.JL_PHOTOSWIPE_LIGHTBOX = window.JL_PHOTOSWIPE_LIGHTBOX || {}; window.JL_PHOTOSWIPE_LIGHTBOX[GID] = lightbox; console.debug('[JL-Gallery] exposed lightbox as window.JL_PHOTOSWIPE_LIGHTBOX["' + GID + '"]'); } catch (e) { /* ignore */ }

    // register a custom caption UI element per PhotoSwipe docs
    lightbox.on('uiRegister', function() {
        lightbox.pswp.ui.registerElement({
            name: 'custom-caption',
            order: 9,
            isButton: false,
            appendTo: 'root',
            html: '<div class="pswp__custom-caption" aria-hidden="false"></div>',
            onInit: function(el, pswp) {
                pswp.on('change', function() {
                    var curr = pswp.currSlide && pswp.currSlide.data && pswp.currSlide.data.element;
                    var captionHTML = '';
                    if (curr) {
                        // Try hidden element first
                        var hidden = curr.querySelector && curr.querySelector('.hidden-caption-content');
                        if (hidden) captionHTML = hidden.innerHTML;
                        else {
                            var title = curr.getAttribute && curr.getAttribute('data-pswp-caption-title') || '';
                            var series = curr.getAttribute && curr.getAttribute('data-pswp-caption-series') || '';
                            var dims = curr.getAttribute && curr.getAttribute('data-pswp-caption-dimensions') || '';
                            var date = curr.getAttribute && curr.getAttribute('data-pswp-caption-date') || '';
                            // Combine title and date on first line
                            if (title || date) {
                                captionHTML += '<div class="pswp-caption-title">';
                                if (title) captionHTML += title;
                                if (title && date) captionHTML += ' â€” ';
                                if (date) captionHTML += date;
                                captionHTML += '</div>';
                            }
                            if (series) captionHTML += '<div class="pswp-caption-title pswp-caption-series">' + series + '</div>';
                            if (dims) {
                                captionHTML += '<div class="pswp-caption-meta">' + dims + '</div>';
                            }
                        }
                    }
                    el.innerHTML = captionHTML || '';
                });
            }
        });
    });
</script>

{{ end }}