{{/* gallery shortcode: reads images.json from the page bundle and exposes a JS array of image objects with resolved
URLs. */}}
{{ $jres := .Page.Resources.GetMatch "images.json" }}
{{ if not $jres }}
<p class="jl-gallery-missing">No images.json found for this page.</p>
{{ else }}
{{ $raw := $jres.Content }}
{{ $images := transform.Unmarshal $raw }}
{{ $imgsSlice := slice }}
{{ range $i, $img := $images }}
{{ $fname := path.Base $img.file }}
{{ $res := $.Page.Resources.GetMatch (printf "media/%s" $fname) }}
{{ $url := "" }}
{{ if $res }}
{{ $url = $res.RelPermalink }}
{{ else }}
{{/* try site static path fallback */}}
{{ $url = (printf "/%s" (printf "docs/%s/%s" .Page.File.Dir $fname)) | relURL }}
{{ end }}
{{ $entry := dict "url" $url "title" $img.title "date" $img.date "dimensions" $img.dimensions_physical "notes"
$img.notes "id" $img.id "original_name" $img.original_name }}
{{ $imgsSlice = $imgsSlice | append $entry }}
{{ end }}
{{ $imgs := $imgsSlice }}

{{ $first := index $imgs 0 }}
<div class="jl-gallery" data-gallery-uid="{{ .Page.File.Path | urlize }}">
    <div class="jl-gallery-image-wrap"><img class="jl-gallery-img" src="{{ $first.url }}" alt="{{ $first.title }}" />
    </div>
    <div class="jl-gallery-meta">
        <h3 class="jl-gallery-title">{{ $first.title }}</h3>
        <div class="jl-gallery-details">
            <span class="jl-gallery-date">{{ $first.date }}</span>
            <span class="jl-gallery-dimensions">{{ $first.dimensions }}</span>
        </div>
        <p class="jl-gallery-notes">{{ $first.notes }}</p>
    </div>

    <div class="jl-gallery-controls">
        <button class="jl-gallery-btn jl-prev" aria-label="Previous">‹</button>
        <button class="jl-gallery-btn jl-next" aria-label="Next">›</button>
    </div>
</div>
{{/* expose images data for the gallery script */}}
<script>window.JL_GALLERY_IMAGES = window.JL_GALLERY_IMAGES || {}; window.JL_GALLERY_IMAGES["{{ .Page.File.Path | urlize }}"] = {{ $imgs | jsonify | safeJS }};</script>

{{/* PhotoSwipe (v4) includes via CDN and local gallery assets */}}
<link rel="stylesheet" href="https://unpkg.com/photoswipe@4.1.3/dist/photoswipe.css">
<link rel="stylesheet" href="https://unpkg.com/photoswipe@4.1.3/dist/default-skin/default-skin.css">
<script src="https://unpkg.com/photoswipe@4.1.3/dist/photoswipe.min.js" defer></script>
<script src="https://unpkg.com/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js" defer></script>

<link rel="stylesheet" href="{{ "/css/gallery.css" | relURL }}">
<script src="{{ "/js/gallery.js" | relURL }}" defer></script>

{{/* PhotoSwipe root markup (required structure) */}}
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>
{{ end }}