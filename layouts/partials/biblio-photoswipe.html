{{/* Initialize PhotoSwipe for bibliography links on this page */}}
<link rel="stylesheet" href="https://unpkg.com/photoswipe@5/dist/photoswipe.css">

{{ $ver := now.Unix }}
<link rel="stylesheet" href="{{ printf "%s%s?v=%d" .Site.BaseURL "css/gallery.css" $ver }}">

<script type="module" defer>
    import PhotoSwipeLightbox from 'https://unpkg.com/photoswipe@5/dist/photoswipe-lightbox.esm.js';

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initBiblioPhotoSwipe);
    } else {
        initBiblioPhotoSwipe();
    }

    function initBiblioPhotoSwipe() {
        const biblioLinks = document.querySelectorAll('a.biblio-pswp-link');
        console.debug('[Biblio-PhotoSwipe] Found', biblioLinks.length, 'bibliography links');

        if (biblioLinks.length === 0) return;

        const lightbox = new PhotoSwipeLightbox({
            gallery: 'body',
            children: 'a.biblio-pswp-link',
            pswpModule: () => import('https://unpkg.com/photoswipe@5/dist/photoswipe.esm.js'),
            
            showHideAnimationType: 'fade',
            // Padding as percentage of viewport - reads from CSS variable --pswp-padding-percent
            paddingFn: (viewportSize) => {
                const paddingPercent = parseFloat(
                    getComputedStyle(document.documentElement)
                        .getPropertyValue('--pswp-padding-percent')
                ) / 100 || 0.10;
                return {
                    top: Math.round(viewportSize.y * paddingPercent),
                    bottom: Math.round(viewportSize.y * paddingPercent),
                    left: Math.round(viewportSize.x * paddingPercent),
                    right: Math.round(viewportSize.x * paddingPercent)
                };
            }
        });

        lightbox.init();
        lightbox.options.loop = false;
        console.debug('[Biblio-PhotoSwipe] Initialized');

        // Optional: Add custom caption with alt text
        lightbox.on('uiRegister', function() {
            lightbox.pswp.ui.registerElement({
                name: 'custom-caption',
                order: 9,
                isButton: false,
                appendTo: 'root',
                html: '<div class="pswp__custom-caption" aria-hidden="false"></div>',
                onInit: function(el, pswp) {
                    pswp.on('change', function() {
                        var curr = pswp.currSlide && pswp.currSlide.data && pswp.currSlide.data.element;
                        var captionHTML = '';
                        if (curr) {
                            var alt = curr.getAttribute && curr.getAttribute('data-pswp-alt') || '';
                            if (alt) {
                                captionHTML = '<div class="pswp-caption-title">' + alt + '</div>';
                            }
                        }
                        el.innerHTML = captionHTML || '';
                    });
                }
            });
        });

        // Expose for debugging
        try { 
            window.JL_BIBLIO_PHOTOSWIPE = lightbox; 
            console.debug('[Biblio-PhotoSwipe] Exposed as window.JL_BIBLIO_PHOTOSWIPE');
        } catch (e) { /* ignore */ }
    }
</script>
